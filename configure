#!/bin/bash
# configure script for calcimp R package
# Automatically downloads and builds cephes-lib if not present

set -e

echo "Configuring calcimp R package..."

# Check for required tools
for cmd in git autoconf automake libtool make; do
    if ! command -v $cmd &> /dev/null; then
        echo "Warning: $cmd not found. Build may fail if cephes-lib needs to be built."
    fi
done

# Determine the source directory (where this configure script is located)
# This is important because devtools::install() may run configure in a different directory
SOURCE_DIR="$(cd "$(dirname "$0")" && pwd)"
echo "Source directory: ${SOURCE_DIR}"

# Define cephes-lib location relative to source directory
CEPHES_DIR="${SOURCE_DIR}/.cephes-lib"
CEPHES_LIB="${CEPHES_DIR}/libmd.a"
CEPHES_HEADER="${CEPHES_DIR}/mconf.h"

# Check if CEPHES_PATH is set
if [ -n "${CEPHES_PATH}" ]; then
    echo "CEPHES_PATH is set to: ${CEPHES_PATH}"
    if [ -f "${CEPHES_PATH}/libmd.a" ]; then
        echo "Using existing cephes library at ${CEPHES_PATH}"
        MAKEVARS_FILE="${SOURCE_DIR}/src/Makevars"
        echo "PKG_CPPFLAGS=-I${CEPHES_PATH}" > "${MAKEVARS_FILE}"
        echo "PKG_LIBS=-L${CEPHES_PATH} -lmd -lm" >> "${MAKEVARS_FILE}"
        exit 0
    else
        echo "Warning: CEPHES_PATH set but libmd.a not found at ${CEPHES_PATH}/libmd.a"
    fi
fi

# Check if cephes-lib already exists and is built
if [ -f "${CEPHES_LIB}" ] && [ -f "${CEPHES_HEADER}" ]; then
    echo "Cephes library already built at ${CEPHES_DIR}"
else
    echo "Cephes library not found. Downloading from GitHub..."

    # Remove old directory if it exists but is incomplete
    if [ -d "${CEPHES_DIR}" ]; then
        echo "Removing incomplete cephes-lib directory..."
        rm -rf "${CEPHES_DIR}"
    fi

    # Clone the repository
    echo "Cloning cephes-lib from GitHub..."
    if ! git clone https://github.com/Yoshinobu-Ishizaki/cephes-lib.git "${CEPHES_DIR}"; then
        echo "Error: Failed to clone cephes-lib repository"
        exit 1
    fi

    # Build cephes-lib
    echo "Building cephes-lib..."
    (
        cd "${CEPHES_DIR}"

        if [ ! -f "configure" ]; then
            echo "Running autoreconf to generate configure script..."
            autoreconf -i
        fi

        ./configure CFLAGS="-fPIC -O2"
        make
    )
fi

# Detect platform and set linker flags accordingly
UNAME_S=$(uname -s)
echo "Detected platform: ${UNAME_S}"

# Create Makevars with absolute paths to cephes-lib
MAKEVARS_FILE="${SOURCE_DIR}/src/Makevars"
echo "Creating Makevars at: ${MAKEVARS_FILE}"

if [ "$UNAME_S" = "Darwin" ]; then
    # macOS does not support --whole-archive or -Bsymbolic
    echo "PKG_CPPFLAGS=-I${CEPHES_DIR}" > "${MAKEVARS_FILE}"
    echo "PKG_LIBS=${CEPHES_LIB} -lm" >> "${MAKEVARS_FILE}"
elif [ "$UNAME_S" = "Windows_NT" ]; then
    # Windows: keep it simple
    echo "PKG_CPPFLAGS=-I${CEPHES_DIR}" > "${MAKEVARS_FILE}"
    echo "PKG_LIBS=${CEPHES_LIB} -lm" >> "${MAKEVARS_FILE}"
else
    # Linux and others
    echo "PKG_CPPFLAGS=-I${CEPHES_DIR}" > "${MAKEVARS_FILE}"
    echo "PKG_LIBS=-Wl,--whole-archive ${CEPHES_LIB} -Wl,--no-whole-archive -lm -Wl,-Bsymbolic" >> "${MAKEVARS_FILE}"
fi

# Add other compilation flags
cat >> "${MAKEVARS_FILE}" << 'EOF'

# Additional compilation flags
PKG_CPPFLAGS += -std=gnu99 -D_GNU_SOURCE

# pkg-config for glib-2.0 and gsl if available
PKG_CPPFLAGS += $(shell pkg-config --cflags glib-2.0 gsl 2>/dev/null || echo "")
PKG_LIBS += $(shell pkg-config --libs glib-2.0 gsl 2>/dev/null || echo "-lglib-2.0 -lgsl -lgslcblas")
EOF

echo "Configuration complete."
