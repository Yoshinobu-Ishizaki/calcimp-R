#!/bin/bash
# Unified configure script for calcimp R package
# Works on Linux, macOS, and Windows (via MSYS2/Rtools)

set -e

echo "Configuring calcimp R package..."

# Detect platform
UNAME_S=$(uname -s 2>/dev/null || echo "Unknown")
case "${UNAME_S}" in
    Linux*)     PLATFORM=Linux;;
    Darwin*)    PLATFORM=Mac;;
    CYGWIN*)    PLATFORM=Windows;;
    MINGW*)     PLATFORM=Windows;;
    MSYS*)      PLATFORM=Windows;;
    *)          PLATFORM=Unknown;;
esac

echo "Detected platform: ${PLATFORM} (${UNAME_S})"

# Check for required tools (skip on Windows where they might not be available)
if [ "${PLATFORM}" != "Windows" ]; then
    for cmd in git autoconf automake libtool make; do
        if ! command -v $cmd &> /dev/null; then
            echo "Warning: $cmd not found. Build may fail if cephes-lib needs to be built."
        fi
    done
fi

# Determine the source directory
SOURCE_DIR="$(cd "$(dirname "$0")" && pwd)"
echo "Source directory: ${SOURCE_DIR}"

# Define cephes-lib location relative to source directory
CEPHES_DIR="${SOURCE_DIR}/.cephes-lib"
CEPHES_LIB="${CEPHES_DIR}/libmd.a"
CEPHES_HEADER="${CEPHES_DIR}/mconf.h"

# Use single Makevars file for all platforms
MAKEVARS_FILE="${SOURCE_DIR}/src/Makevars"

# Check if CEPHES_PATH is set
if [ -n "${CEPHES_PATH}" ]; then
    echo "CEPHES_PATH is set to: ${CEPHES_PATH}"
    if [ -f "${CEPHES_PATH}/libmd.a" ]; then
        echo "Using existing cephes library at ${CEPHES_PATH}"
        echo "PKG_CPPFLAGS=-I${CEPHES_PATH} -std=gnu99 -D_GNU_SOURCE" > "${MAKEVARS_FILE}"
        echo "PKG_LIBS=${CEPHES_PATH}/libmd.a -lm" >> "${MAKEVARS_FILE}"
        exit 0
    else
        echo "Warning: CEPHES_PATH set but libmd.a not found at ${CEPHES_PATH}/libmd.a"
    fi
fi

# Check if cephes-lib already exists and is built
if [ -f "${CEPHES_LIB}" ] && [ -f "${CEPHES_HEADER}" ]; then
    echo "Cephes library already built at ${CEPHES_DIR}"
else
    echo "Cephes library not found. Downloading from GitHub..."

    # Remove old directory if it exists but is incomplete
    if [ -d "${CEPHES_DIR}" ]; then
        echo "Removing incomplete cephes-lib directory..."
        rm -rf "${CEPHES_DIR}"
    fi

    # Clone the repository
    echo "Cloning cephes-lib from GitHub..."
    if ! git clone https://github.com/Yoshinobu-Ishizaki/cephes-lib.git "${CEPHES_DIR}"; then
        echo "Error: Failed to clone cephes-lib repository"
        exit 1
    fi

    # Build cephes-lib
    echo "Building cephes-lib..."
    (
        cd "${CEPHES_DIR}"

        if [ ! -f "configure" ]; then
            echo "Running autoreconf to generate configure script..."
            if [ "${PLATFORM}" = "Windows" ]; then
                autoreconf -i || echo "Warning: autoreconf failed, trying to use existing Makefile"
            else
                autoreconf -i
            fi
        fi

        if [ -f "configure" ]; then
            ./configure CFLAGS="-fPIC -O2" || echo "Warning: configure failed"
        fi

        # Build the library
        if [ -f "Makefile" ]; then
            if ! make; then
                echo "Error: Failed to build cephes-lib"
                exit 1
            fi
        else
            echo "Warning: No Makefile found in cephes-lib"
            echo "You may need to build cephes-lib manually"
        fi
    )

    # Verify the library was built
    if [ ! -f "${CEPHES_LIB}" ]; then
        echo "Error: libmd.a was not created"
        echo "Please build cephes-lib manually and set CEPHES_PATH"
        exit 1
    fi

    echo "Successfully built cephes-lib"
fi

echo "Cephes library location: ${CEPHES_DIR}"
echo "Creating unified Makevars at: ${MAKEVARS_FILE}"

# Create a single Makevars that works on all platforms
cat > "${MAKEVARS_FILE}" << 'EOF'
# Makevars generated by configure script
# Works on Linux, macOS, and Windows

# Detect platform
UNAME_S := $(shell uname -s 2>/dev/null || echo Windows)

# Base flags
EOF

echo "PKG_CPPFLAGS = -I${CEPHES_DIR} -std=gnu99 -D_GNU_SOURCE" >> "${MAKEVARS_FILE}"

cat >> "${MAKEVARS_FILE}" << 'EOF'

# Platform-specific linker flags
ifeq ($(UNAME_S),Darwin)
    # macOS - no --whole-archive or -Bsymbolic support
EOF
echo "    PKG_LIBS = ${CEPHES_LIB} -lm" >> "${MAKEVARS_FILE}"
cat >> "${MAKEVARS_FILE}" << 'EOF'
else ifeq ($(UNAME_S),Linux)
    # Linux - use whole-archive and -Bsymbolic
EOF
echo "    PKG_LIBS = -Wl,--whole-archive ${CEPHES_LIB} -Wl,--no-whole-archive -lm -Wl,-Bsymbolic" >> "${MAKEVARS_FILE}"
cat >> "${MAKEVARS_FILE}" << 'EOF'
else
    # Windows (MINGW/MSYS/CYGWIN) - allow multiple definitions for Bessel function conflicts
EOF
echo "    PKG_LIBS = ${CEPHES_LIB} -lm -Wl,--allow-multiple-definition" >> "${MAKEVARS_FILE}"
cat >> "${MAKEVARS_FILE}" << 'EOF'
endif

# Try to find glib-2.0 and gsl via pkg-config
PKG_CPPFLAGS += $(shell pkg-config --cflags glib-2.0 gsl 2>/dev/null || echo "")
PKG_LIBS += $(shell pkg-config --libs glib-2.0 gsl 2>/dev/null || echo "-lgsl -lgslcblas")

# On Windows, if pkg-config fails, try common MinGW locations for glib
ifeq ($(findstring Windows,$(UNAME_S)),Windows)
    ifeq ($(shell pkg-config --libs glib-2.0 2>/dev/null),)
        ifneq ($(wildcard $(MINGW_PREFIX)/include/glib-2.0),)
            PKG_CPPFLAGS += -I$(MINGW_PREFIX)/include/glib-2.0 -I$(MINGW_PREFIX)/lib/glib-2.0/include
            PKG_LIBS += -L$(MINGW_PREFIX)/lib -lglib-2.0 -lintl -liconv
        endif
    endif
endif
EOF

echo "Configuration complete for ${PLATFORM}!"
echo ""
echo "Note: Using single Makevars file for all platforms."
echo "If you need platform-specific Makevars.win, modify the configure script."
