#!/bin/bash
# configure script for calcimp R package
# Automatically downloads and builds cephes-lib if not present

set -e

echo "Configuring calcimp R package..."

# Check for required tools
for cmd in git autoconf automake libtool make; do
    if ! command -v $cmd &> /dev/null; then
        echo "Warning: $cmd not found. Build may fail if cephes-lib needs to be built."
    fi
done

# Define cephes-lib location
CEPHES_DIR=".cephes-lib"
CEPHES_LIB="${CEPHES_DIR}/libmd.a"
CEPHES_HEADER="${CEPHES_DIR}/mconf.h"

# Check if CEPHES_PATH is set
if [ -n "${CEPHES_PATH}" ]; then
    echo "CEPHES_PATH is set to: ${CEPHES_PATH}"
    if [ -f "${CEPHES_PATH}/libmd.a" ]; then
        echo "Using existing cephes library at ${CEPHES_PATH}"
        echo "PKG_CPPFLAGS=-I${CEPHES_PATH}" > src/Makevars.in
        echo "PKG_LIBS=-L${CEPHES_PATH} -lmd -lm" >> src/Makevars.in
        exit 0
    else
        echo "Warning: CEPHES_PATH set but libmd.a not found at ${CEPHES_PATH}/libmd.a"
    fi
fi

# Check if cephes-lib already exists and is built
if [ -f "${CEPHES_LIB}" ] && [ -f "${CEPHES_HEADER}" ]; then
    echo "Cephes library already built at ${CEPHES_DIR}"
else
    echo "Cephes library not found. Downloading from GitHub..."

    # Remove old directory if it exists but is incomplete
    if [ -d "${CEPHES_DIR}" ]; then
        echo "Removing incomplete cephes-lib directory..."
        rm -rf "${CEPHES_DIR}"
    fi

    # Clone the repository
    echo "Cloning cephes-lib from GitHub..."
    if ! git clone https://github.com/Yoshinobu-Ishizaki/cephes-lib.git "${CEPHES_DIR}"; then
        echo "Error: Failed to clone cephes-lib repository"
        exit 1
    fi

    # Build cephes-lib
    echo "Building cephes-lib..."
    cd "${CEPHES_DIR}"

    # Check if configure script exists
    if [ ! -f "configure" ]; then
        echo "Running autoreconf to generate configure script..."
        if ! autoreconf -i; then
            echo "Error: Failed to generate configure script"
            exit 1
        fi
    fi

    # Configure and build with -fPIC for shared library compatibility
    # Use -O2 to disable optimization and avoid numerical precision issues
    if ! ./configure CFLAGS="-O2 -fPIC"; then
        echo "Error: Failed to configure cephes-lib"
        exit 1
    fi

    if ! make; then
        echo "Error: Failed to build cephes-lib"
        exit 1
    fi

    cd ..

    # Verify the library was built
    if [ ! -f "${CEPHES_LIB}" ]; then
        echo "Error: libmd.a was not created"
        exit 1
    fi

    echo "Successfully built cephes-lib"
fi

# Get absolute path to cephes-lib
CEPHES_ABS_PATH="$(cd ${CEPHES_DIR} && pwd)"
echo "Cephes library location: ${CEPHES_ABS_PATH}"

# ============================================================================
# Test struve function
# ============================================================================
echo ""
echo "Testing struve function..."

# Create test C program
cat > test_struve.c << 'EOF'
#include <stdio.h>
#include <math.h>
#include "mconf.h"

// Declare struve function from cephes
double struve(double v, double x);

int main() {
    double result = struve(1.0, 0.059978);
    double expected = 0.000763201;
    double tolerance = 1e-6;
    
    printf("struve(1, 0.059978) = %.10f\n", result);
    printf("Expected: %.10f\n", expected);
    printf("Difference: %.10e\n", fabs(result - expected));
    
    if (fabs(result - expected) < tolerance) {
        printf("TEST PASSED\n");
        return 0;
    } else {
        printf("TEST FAILED: difference exceeds tolerance\n");
        return 1;
    }
}
EOF

# Compile the test program
: ${CC:=gcc}

echo "Compiling struve test program..."
if ! ${CC} -O2 -I${CEPHES_ABS_PATH} -o test_struve test_struve.c ${CEPHES_ABS_PATH}/libmd.a -lm; then
    echo "Error: Failed to compile struve test program"
    rm -f test_struve.c
    exit 1
fi

# Run the test
echo "Running struve test..."
if ./test_struve; then
    echo "struve function test: PASSED"
    TEST_RESULT=0
else
    echo "struve function test: FAILED"
    TEST_RESULT=1
fi

# Clean up test files
rm -f test_struve test_struve.c

# Exit if test failed
if [ ${TEST_RESULT} -ne 0 ]; then
    echo "Error: struve function test failed. Aborting configuration."
    exit 1
fi

echo ""
# ============================================================================

# Create Makevars.in with the cephes-lib path
cat > src/Makevars.in << EOF
# Makevars.in generated by configure script
# This file will be processed to create src/Makevars

# Use the downloaded cephes-lib
CEPHES_PATH = ${CEPHES_ABS_PATH}

# pkg-config for glib-2.0 and gsl
PKG_CFLAGS = \$(shell pkg-config --cflags glib-2.0 gsl 2>/dev/null || echo "") -I\$(CEPHES_PATH)
# Use -Wl,-Bsymbolic to ensure cephes functions call their own symbols (e.g., gamma)
# and -Wl,--whole-archive to include all objects from static library
PKG_LIBS = \$(shell pkg-config --libs glib-2.0 gsl 2>/dev/null || echo "-lglib-2.0 -lgsl -lgslcblas") -Wl,--whole-archive \$(CEPHES_PATH)/libmd.a -Wl,--no-whole-archive -lm -Wl,-Bsymbolic

# Additional compilation flags
PKG_CFLAGS += -std=gnu99 -D_GNU_SOURCE

# Source files to compile
SOURCES = calcimp.c init.c acoustic_constants.c kutils.c zmensur.c xmensur.c \\
          xydata.c matutil.c tinyexpr.c
OBJECTS = \$(SOURCES:.c=.o)
EOF

# Copy Makevars.in to Makevars for the build
cp src/Makevars.in src/Makevars

echo "Configuration complete!"
echo ""
echo "Next steps:"
echo "  R CMD INSTALL ."
echo "  or in R: devtools::install()"
