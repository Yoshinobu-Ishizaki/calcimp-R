---
title: "Test calcimp-R Package"
author: "calcimp-R Tests"
format:
  gfm:
    toc: true
    code-fold: false
execute:
  echo: true
  warning: false
---

## Overview

This document tests the calcimp-R package by calculating impedance for `sample/test.men` and comparing the results with the reference implementation in `sample/test.imp`.

## Load Package

```{r setup}
library(calcimp)
```

## Test Configuration

Test file: `sample/test.men` - A simple cylindrical tube (10mm diameter, 1000mm length)

```{r show-mensur}
# Display the mensur structure
mensur <- print_men("../sample/test.men")
print(mensur)
```

## Calculate Impedance

```{r calculate}
# Calculate impedance using calcimp
result <- calcimp(
  "../sample/test.men",
  max_freq = 2000.0,
  step_freq = 2.5,
  temperature = 24.0,
  rad_calc = PIPE,
  dump_calc = TRUE,
  sec_var_calc = FALSE
)

# Show dimensions
cat("Result dimensions:", dim(result), "\n")
cat("Number of frequency points:", nrow(result), "\n")
cat("\n")

# Show first few rows
head(result, 10)
```

## Load Reference Data

```{r load-reference}
# Load reference data from test.imp
reference <- read.csv("../sample/test.imp")

cat("Reference dimensions:", dim(reference), "\n")
cat("Reference column names:", colnames(reference), "\n")
cat("\n")

# Show first few rows
head(reference, 10)
```

## Compare Results

### Check Dimensions

```{r check-dimensions}
cat("calcimp-R rows:", nrow(result), "\n")
cat("Reference rows:", nrow(reference), "\n")
cat("Dimensions match:", nrow(result) == nrow(reference), "\n")
```

### Compare Frequency Values

```{r compare-freq}
freq_match <- all.equal(result$freq, reference$freq, tolerance = 1e-6)
cat("Frequencies match:", isTRUE(freq_match), "\n")
if (!isTRUE(freq_match)) {
  print(freq_match)
}
```

### Compare Real Part

```{r compare-real}
real_diff <- abs(result$real - reference$imp.real)
max_real_diff <- max(real_diff)
rel_real_error <- max(real_diff / abs(reference$imp.real), na.rm = TRUE)

cat("Max absolute difference (real):", max_real_diff, "\n")
cat("Max relative error (real):", rel_real_error, "\n")
cat("Real parts match (tol=1e-6):", max_real_diff < 1e-6, "\n")
```

### Compare Imaginary Part

```{r compare-imag}
imag_diff <- abs(result$imag - reference$imp.imag)
max_imag_diff <- max(imag_diff)
rel_imag_error <- max(imag_diff / abs(reference$imp.imag), na.rm = TRUE)

cat("Max absolute difference (imag):", max_imag_diff, "\n")
cat("Max relative error (imag):", rel_imag_error, "\n")
cat("Imaginary parts match (tol=1e-6):", max_imag_diff < 1e-6, "\n")
```

### Compare Magnitude

```{r compare-mag}
mag_diff <- abs(result$mag - reference$mag)
max_mag_diff <- max(mag_diff)

cat("Max absolute difference (mag dB):", max_mag_diff, "\n")
cat("Magnitudes match (tol=1e-6 dB):", max_mag_diff < 1e-6, "\n")
```

## Visual Comparison

### Magnitude Spectrum

```{r plot-magnitude, fig.width=10, fig.height=6}
par(mfrow=c(1,2))

# Plot calcimp-R result
plot(result$freq, result$mag, type="l", col="blue", lwd=2,
     xlab="Frequency (Hz)", ylab="Magnitude (dB)",
     main="calcimp-R Result")
grid()

# Plot reference
plot(reference$freq, reference$mag, type="l", col="red", lwd=2,
     xlab="Frequency (Hz)", ylab="Magnitude (dB)",
     main="Reference (test.imp)")
grid()
```

### Overlay Comparison

```{r plot-overlay, fig.width=10, fig.height=8}
par(mfrow=c(2,1))

# Magnitude overlay
plot(result$freq, result$mag, type="l", col="blue", lwd=2,
     xlab="Frequency (Hz)", ylab="Magnitude (dB)",
     main="Magnitude Comparison: calcimp-R (blue) vs Reference (red)")
lines(reference$freq, reference$mag, col="red", lwd=2, lty=2)
legend("bottomright", legend=c("calcimp-R", "Reference"),
       col=c("blue", "red"), lwd=2, lty=c(1,2))
grid()

# Difference plot
plot(result$freq, result$mag - reference$mag, type="l", col="darkgreen", lwd=2,
     xlab="Frequency (Hz)", ylab="Difference (dB)",
     main="Magnitude Difference (calcimp-R - Reference)")
abline(h=0, col="gray", lty=2)
grid()
```

### Real and Imaginary Parts

```{r plot-complex, fig.width=10, fig.height=8}
par(mfrow=c(2,1))

# Real part
plot(result$freq, result$real, type="l", col="blue", lwd=2,
     xlab="Frequency (Hz)", ylab="Real Part",
     main="Real Part Comparison")
lines(reference$freq, reference$imp.real, col="red", lwd=2, lty=2)
legend("topleft", legend=c("calcimp-R", "Reference"),
       col=c("blue", "red"), lwd=2, lty=c(1,2))
grid()

# Imaginary part
plot(result$freq, result$imag, type="l", col="blue", lwd=2,
     xlab="Frequency (Hz)", ylab="Imaginary Part",
     main="Imaginary Part Comparison")
lines(reference$freq, reference$imp.imag, col="red", lwd=2, lty=2)
legend("topleft", legend=c("calcimp-R", "Reference"),
       col=c("blue", "red"), lwd=2, lty=c(1,2))
grid()
```

## Detailed Error Analysis

```{r error-analysis}
# Create comparison data frame
comparison <- data.frame(
  freq = result$freq,
  real_R = result$real,
  real_ref = reference$imp.real,
  real_diff = result$real - reference$imp.real,
  imag_R = result$imag,
  imag_ref = reference$imp.imag,
  imag_diff = result$imag - reference$imp.imag,
  mag_R = result$mag,
  mag_ref = reference$mag,
  mag_diff = result$mag - reference$mag
)

# Show rows with largest differences
cat("\nRows with largest magnitude differences:\n")
top_mag_diff <- head(comparison[order(-abs(comparison$mag_diff)), ], 10)
print(top_mag_diff[, c("freq", "mag_R", "mag_ref", "mag_diff")])
```

## Summary

```{r summary}
# Calculate summary statistics
summary_stats <- data.frame(
  Component = c("Frequency", "Real", "Imaginary", "Magnitude"),
  Max_Abs_Diff = c(
    max(abs(result$freq - reference$freq)),
    max(abs(result$real - reference$imp.real)),
    max(abs(result$imag - reference$imp.imag)),
    max(abs(result$mag - reference$mag))
  ),
  Mean_Abs_Diff = c(
    mean(abs(result$freq - reference$freq)),
    mean(abs(result$real - reference$imp.real)),
    mean(abs(result$imag - reference$imp.imag)),
    mean(abs(result$mag - reference$mag))
  ),
  RMSE = c(
    sqrt(mean((result$freq - reference$freq)^2)),
    sqrt(mean((result$real - reference$imp.real)^2)),
    sqrt(mean((result$imag - reference$imp.imag)^2)),
    sqrt(mean((result$mag - reference$mag)^2))
  )
)

print(summary_stats)

# Overall test result
all_match <- max_real_diff < 1e-3 && max_imag_diff < 1e-3 && max_mag_diff < 1e-3
cat("\n")
cat("========================================\n")
cat("OVERALL TEST RESULT:", ifelse(all_match, "PASS âœ“", "NEEDS REVIEW"), "\n")
cat("========================================\n")
cat("\nTolerance: 1e-3 (0.001)\n")
cat("Real part:      ", ifelse(max_real_diff < 1e-3, "PASS", "FAIL"),
    "(max diff:", sprintf("%.2e", max_real_diff), ")\n")
cat("Imaginary part: ", ifelse(max_imag_diff < 1e-3, "PASS", "FAIL"),
    "(max diff:", sprintf("%.2e", max_imag_diff), ")\n")
cat("Magnitude:      ", ifelse(max_mag_diff < 1e-3, "PASS", "FAIL"),
    "(max diff:", sprintf("%.2e", max_mag_diff), "dB )\n")
```

## Session Info

```{r session-info}
sessionInfo()
```
